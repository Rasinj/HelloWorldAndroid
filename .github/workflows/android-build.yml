name: Android CI - Ultimate Optimization

on:
  push:
    branches: [ main, master, ci-optimize-combined ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: write
  actions: read
  packages: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Setup Android SDK (Optimized)
      run: |
        chmod +x .github/scripts/setup-android-sdk.sh
        ./.github/scripts/setup-android-sdk.sh
    
    - name: Enhanced Gradle and Android Build Cache
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
          ~/.gradle/configuration-cache
          ~/.gradle/kotlin-dsl
          ~/.gradle/build-cache
          .gradle/caches
          .gradle/wrapper
          .gradle/configuration-cache
          .gradle/kotlin-dsl
          .gradle/build-cache
          ~/.android/build-cache
          .android/build-cache
        key: ${{ runner.os }}-gradle-enhanced-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', 'gradle.properties', '**/*.kt', '**/*.java') }}
        restore-keys: |
          ${{ runner.os }}-gradle-enhanced-
          ${{ runner.os }}-gradle-
    
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
    
    - name: Warm up Gradle daemon and pre-compile
      run: |
        ./gradlew help --daemon --build-cache --configuration-cache
        ./gradlew compileDebugKotlin --build-cache --configuration-cache --daemon
    
    - name: Build with Gradle (Ultimate Performance)
      run: |
        ./gradlew assembleDebug \
          --parallel \
          --build-cache \
          --daemon \
          --configuration-cache \
          --max-workers=4 \
          --gradle-user-home ~/.gradle \
          -Dorg.gradle.jvmargs="-Xmx4096m -XX:+UseG1GC -XX:+UseStringDeduplication" \
          -Dkotlin.compiler.execution.strategy=in-process \
          -Dkotlin.incremental=true \
          -Pandroid.enableR8.fullMode=true \
          -Pandroid.enableBuildCache=true
    
    - name: Upload APK artifact (Compressed)
      uses: actions/upload-artifact@v4
      with:
        name: NoteMaster-APK-Ultimate-${{ github.run_number }}
        path: app/build/outputs/apk/debug/NoteMaster-*.apk
        retention-days: 30
        compression-level: 9
    
    - name: Create Release
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.ref == 'refs/heads/ci-optimize-combined'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v2.0.${{ github.run_number }}-ultimate
        name: NoteMaster v2.0.${{ github.run_number }} - Ultimate Optimized Build
        body: |
          🚀 **NoteMaster v2.0 - Ultimate Optimized Build**
          
          **Performance Optimizations Applied:**
          - ⚡ Enhanced Gradle build cache with configuration cache
          - 🛠️ Optimized Android SDK setup (pre-installed components)
          - 🔧 Ultimate Gradle performance flags and JVM tuning
          - 📦 Compressed artifact upload (level 9)
          - 🏗️ Multi-worker parallel builds (max 4 workers)
          - 💾 Comprehensive caching strategy (Gradle + Android build cache)
          - 🚀 Pre-compilation and daemon warm-up optimizations
          
          **Features:**
          - 🌟 Completely redesigned professional UI with modern dialogs
          - 📝 Enhanced note creation with styled input fields and labels
          - 🎯 Beautiful note details view with category badges
          - ✏️ Improved edit dialog with better typography and spacing
          - 🔍 Enhanced search interface with clear/search actions
          - 🎨 Professional color scheme and visual hierarchy
          - 📱 Optimized spacing and padding for better user experience
          
          **Technical Details:**
          - Built from commit ${{ github.sha }}
          - Version: 2.0 Ultimate
          - Generated on ${{ github.event.head_commit.timestamp }}
          - Build optimizations: All applied
        files: app/build/outputs/apk/debug/NoteMaster-*.apk
        draft: false
        prerelease: false
        make_latest: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}